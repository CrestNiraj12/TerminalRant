name: release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  goreleaser:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Build release notes from CHANGELOG.md
        run: |
          TAG="${GITHUB_REF_NAME}"

          echo "Generating release notes for $TAG"

          rm -f /tmp/release_notes.md

          # ---- HEADER ----
          if [ -f release-header.md ]; then
            sed "s/{{ .Version }}/${TAG}/g" release-header.md >> /tmp/release_notes.md
            echo "" >> /tmp/release_notes.md
          fi

          # ---- CHANGELOG SECTION ----
          awk -v ver="$TAG" '
            BEGIN { printing=0 }
            /^## \[/ {
              if (printing) exit
              if (index($0, ver) > 0) { printing=1; next }
            }
            printing { print }
          ' CHANGELOG.md >> /tmp/release_notes.md

          # Fallback if section not found
          if ! grep -q . /tmp/release_notes.md; then
            echo "See CHANGELOG.md for details." >> /tmp/release_notes.md
          fi

          echo "" >> /tmp/release_notes.md

          # ---- FOOTER ----
          if [ -f release-footer.md ]; then
            sed "s/{{ .Version }}/${TAG}/g" release-footer.md >> /tmp/release_notes.md
          fi

          echo "Final release notes:"
          cat /tmp/release_notes.md

      - uses: goreleaser/goreleaser-action@v6
        with:
          version: "~> v2"
          args: release --clean --release-notes=/tmp/release_notes.md
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
