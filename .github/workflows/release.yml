name: release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  goreleaser:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Extract release notes from CHANGELOG.md
        id: changelog
        run: |
          # Extract the version from the tag (remove 'v' prefix for matching)
          VERSION="${GITHUB_REF_NAME}"

          # Extract the section for this version from CHANGELOG.md
          # This matches from "## [vX.X.X]" until the next "## [" or end of file
          RELEASE_NOTES=$(awk -v ver="$VERSION" '
            BEGIN { found=0; printing=0 }
            /^## \[/ {
              if (printing) exit
              if (index($0, ver) > 0) { found=1; printing=1; next }
            }
            printing { print }
          ' CHANGELOG.md)

          # If no specific version found, use a default message
          if [ -z "$RELEASE_NOTES" ]; then
            RELEASE_NOTES="See [CHANGELOG.md](https://github.com/CrestNiraj12/terminalrant/blob/main/CHANGELOG.md) for details."
          fi

          # Write release notes to a temporary file
          echo "$RELEASE_NOTES" > /tmp/release_notes.md

          echo "Release notes extracted for $VERSION"

      - name: Read release header and footer
        id: release_templates
        run: |
          # Read header and footer files, replacing {{ .Version }} with actual version
          HEADER=$(sed "s/{{ .Version }}/${GITHUB_REF_NAME}/g" release-header.md)
          FOOTER=$(sed "s/{{ .Version }}/${GITHUB_REF_NAME}/g" release-footer.md)

          # Export as environment variables using heredoc for multiline
          {
            echo "RELEASE_HEADER<<EOF"
            echo "$HEADER"
            echo "EOF"
          } >> "$GITHUB_ENV"

          {
            echo "RELEASE_FOOTER<<EOF"
            echo "$FOOTER"
            echo "EOF"
          } >> "$GITHUB_ENV"

      - uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: ~> v2
          args: release --clean --release-notes=/tmp/release_notes.md
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
          RELEASE_HEADER: ${{ env.RELEASE_HEADER }}
          RELEASE_FOOTER: ${{ env.RELEASE_FOOTER }}
